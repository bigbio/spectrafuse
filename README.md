# spectrafuse

Incremental spectral clustering pipeline from [quantms data](https://quantms.org). quantms is a workflow for reanalysis of public proteomics data. quantms not only releases a workflow to the public but also performs reanalysis of public proteomics data in a systematic way for TMT, LFQ, ITRAQ and other DDA methods.

quantms has reanalyzed an extensive number of datasets with almost 1 billion MS/MS (Mass Spectrometry/Mass Spectrometry) MS2 analyzed, comprising nearly 100 million PSMs (Peptide-Spectrum Matches) derived from various tissues, cell lines, and diseases. In light of this vast wealth of data, spectrafuse aims to apply spectral clustering techniques to organize this data and construct spectral libraries.

[spectrafuse](https://github.com/bigbio/spectrafuse) is a Nextflow workflow that performs incremental clustering of quantms data and is based on the tool [MaRaCluster](https://github.com/statisticalbiotechnology/maracluster).

The workflow in a nutshell:

![image](https://github.com/bigbio/spectrafuse/assets/52113/24a7c9ac-7287-421c-b8f1-6319764ed29c)

Reference: https://github.com/bigbio/spectrafuse/blob/main/docs/algorithm.png

The workflow is designed to be run in a high-performance computing environment, and it is built using [Nextflow](https://www.nextflow.io/). It uses Docker/Singularity containers making installation trivial and results highly reproducible. The [Nextflow DSL2](https://www.nextflow.io/docs/latest/dsl2.html) implementation of this pipeline uses one container per process which makes it much easier to maintain and update software dependencies.

## Table of Contents

- [Workflow Overview](#workflow-overview)
- [Input Requirements](#input-requirements)
- [Installation](#installation)
- [Usage](#usage)
- [Parameters](#parameters)
- [Output Structure](#output-structure)
- [Profiles](#profiles)
- [Examples](#examples)

## Workflow Overview

The spectrafuse workflow performs **two-phase clustering**:

### Phase 1: Project-Level Clustering

1. **MGF Converter** (`GENERATE_MGF_FILES`): Converts parquet files from each project into MGF format, organized by species, instrument, and charge state.

2. **Project-Level MaRaCluster** (`RUN_MARACLUSTER_PROJECT`): Clusters MGF files within each project, grouping by species, instrument, and charge. This produces project-specific clustering results.

3. **Project-Level MSP Generation** (`GENERATE_MSP_FORMAT_PROJECT`): Generates MSP format files for each project, creating consensus spectra from the project-level clusters.

4. **Project MSP Combination** (`COMBINE_PROJECT_MSP`): Combines all MSP files from a project (across all charge states and instruments) into a single project-level MSP file.

### Phase 2: Global Clustering

5. **Global MaRaCluster** (`RUN_MARACLUSTER_GLOBAL`): Clusters MGF files across **all projects**, grouping by species, instrument, and charge. This creates global clusters that span multiple projects.

6. **Global MSP Generation** (`GENERATE_MSP_FORMAT_GLOBAL`): Generates final MSP format files from the global clustering results, creating consensus spectra from clusters that include spectra from multiple projects.

### Key Features

- **Incremental Clustering**: Two-phase approach allows for project-specific libraries and global libraries
- **Parallel Processing**: Projects are processed in parallel for efficiency
- **Organized by Metadata**: Clustering is performed separately for each combination of species, instrument, and charge state
- **Consensus Spectra**: Multiple strategies available for generating consensus spectra from clusters

## Input Requirements

The workflow requires:

1. **Project Directory Structure**: A directory containing one or more project subdirectories. Each project directory should contain:
   - **Parquet files** (`.parquet`): PSM data files generated by quantms. **Note**: The parquet files MUST contain the corresponding spectra for each identified peptide (mz_array and intensity_array columns).
   - **SDRF files** (`.sdrf.tsv`): Sample and Data Relationship Format files containing metadata about the samples.

2. **Directory Structure**:
   ```
   parquet_dir/
   ├── PXD004732/
   │   ├── *.parquet
   │   └── *.sdrf.tsv
   ├── PXD004733/
   │   ├── *.parquet
   │   └── *.sdrf.tsv
   └── ...
   ```

## Installation

### Prerequisites

- [Nextflow](https://www.nextflow.io/) >= 23.04.0
- Docker, Singularity, Podman, or another container engine
- Java 11 or later (for Nextflow)

### Install Nextflow

```bash
curl -s https://get.nextflow.io | bash
```

### Clone the Repository

```bash
git clone https://github.com/bigbio/spectrafuse.git
cd spectrafuse
```

## Usage

### Basic Usage

```bash
nextflow run main.nf \
    --parquet_dir /path/to/projects \
    -profile docker
```

### With Custom Output Directory

```bash
nextflow run main.nf \
    --parquet_dir /path/to/projects \
    --outdir ./results \
    -profile docker
```

### Resume a Previous Run

```bash
nextflow run main.nf \
    --parquet_dir /path/to/projects \
    -profile docker \
    -resume
```

### Test Run

```bash
nextflow run main.nf \
    -profile test,docker
```

## Parameters

### Required Parameters

| Parameter | Description | Example |
|-----------|-------------|---------|
| `--parquet_dir` | Directory containing project subdirectories with parquet and SDRF files | `/data/projects` |

### MaRaCluster Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--maracluster_pvalue_threshold` | Log10(p-value) threshold for MaRaCluster clustering (e.g., -10.0 = p-value 1e-10) | `-10.0` |
| `--maracluster_precursor_tolerance` | Precursor m/z tolerance in ppm for MaRaCluster | `20.0` |
| `--cluster_threshold` | P-value threshold for MaRaCluster output file naming (e.g., `*_p30.tsv`) | `30` |
| `--maracluster_verbose` | Enable verbose output from MaRaCluster | `false` |

### MGF Generation Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--mgf_verbose` | Enable verbose output from MGF generation | `true` |

### MSP Format Generation Parameters

These parameters control how consensus spectra are generated from clusters.

#### Consensus Strategy

| Parameter | Description | Default | Options |
|-----------|-------------|---------|---------|
| `--strategytype` | Consensus spectrum generation method | `best` | `best`, `most`, `bin`, `average` |

#### Strategy-Specific Parameters

**For `most` method (Most Similar Spectrum):**
| Parameter | Description | Default |
|-----------|-------------|---------|
| `--sim` | Similarity measure method | `dot` |
| `--fragment_mz_tolerance` | Fragment m/z tolerance for spectrum comparison | `0.02` |

**For `bin` method (Binning Strategy):**
| Parameter | Description | Default |
|-----------|-------------|---------|
| `--min_mz` | Minimum m/z value to consider | `100` |
| `--max_mz` | Maximum m/z value to consider | `2000` |
| `--bin_size` | Bin size in m/z units | `0.02` |
| `--peak_quorum` | Relative number of spectra in a cluster that need to contain a peak for it to be included (0.0-1.0) | `0.25` |
| `--edge_case_threshold` | Threshold for correcting m/z edge cases during binning (0.0-1.0) | `0.5` |

**For `average` method (Average Spectrum):**
| Parameter | Description | Default |
|-----------|-------------|---------|
| `--diff_thresh` | Minimum distance between MS/MS peak clusters | `0.01` |
| `--dyn_range` | Dynamic range to apply to output spectra | `1000` |
| `--min_fraction` | Minimum fraction of cluster spectra where MS/MS peak is present (0.0-1.0) | `0.5` |
| `--pepmass` | Peptide mass calculation method | `lower_median` | `naive_average`, `neutral_average`, `lower_median` |
| `--msms_avg` | MS/MS averaging method | `weighted` | `naive`, `weighted` |

### Output Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--outdir` | Output directory for results | `./results` |
| `--publish_dir_mode` | Publish directory mode | `copy` |

### Resource Limits

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--max_memory` | Maximum memory per process | `128.GB` |
| `--max_cpus` | Maximum CPUs per process | `16` |
| `--max_time` | Maximum time per process | `240.h` |

## Output Structure

The workflow generates the following outputs in the `--outdir` directory:

```
results/
├── project_msp_files/          # Project-level MSP files (one per project)
│   ├── PXD004732_project.msp
│   └── PXD004733_project.msp
├── maracluster_results/        # Global MaRaCluster clustering results
│   └── ...
├── msp_files/                  # Global MSP files (by species/instrument/charge)
│   └── ...
└── pipeline_info/              # Pipeline execution metadata
    ├── execution_report.html
    ├── execution_timeline.html
    ├── execution_trace.txt
    └── pipeline_dag.html
```

### Project-Level MSP Files

Located in `project_msp_files/`, these files contain all clusters from a single project, organized by charge state and instrument. Each file is named `{project_id}_project.msp`.

### Global MSP Files

Located in `msp_files/`, these files contain clusters that span multiple projects, organized by species, instrument, and charge state. The directory structure is:
```
msp_files/
└── {species}/
    └── {instrument}/
        └── {charge}/
            └── *.msp
```

## Profiles

Profiles are used to configure the execution environment and container engine.

### Container Engine Profiles

- `docker` - Use Docker containers
- `singularity` - Use Singularity containers
- `podman` - Use Podman containers
- `apptainer` - Use Apptainer containers
- `charliecloud` - Use Charliecloud containers
- `shifter` - Use Shifter containers

### Platform Profiles

- `arm64` - For ARM64 architecture (e.g., Apple Silicon)
- `emulate_amd64` - Emulate AMD64 on ARM64 hosts

### Other Profiles

- `test` - Use test configuration with minimal dataset
- `debug` - Enable debug mode with detailed logging
- `gpu` - Enable GPU support
- `wave` - Use Wave containers

### Example Profile Combinations

```bash
# Docker on x86_64
nextflow run main.nf -profile docker

# Docker on Apple Silicon (ARM64)
nextflow run main.nf -profile docker,arm64

# Singularity on HPC cluster
nextflow run main.nf -profile singularity

# Test run with Docker
nextflow run main.nf -profile test,docker
```

## Examples

### Example 1: Basic Run with Docker

```bash
nextflow run main.nf \
    --parquet_dir /data/quantms_projects \
    --outdir ./results \
    -profile docker
```

### Example 2: Custom Consensus Strategy

```bash
nextflow run main.nf \
    --parquet_dir /data/quantms_projects \
    --strategytype average \
    --min_fraction 0.6 \
    --dyn_range 2000 \
    -profile docker
```

### Example 3: Stricter Clustering Threshold

```bash
nextflow run main.nf \
    --parquet_dir /data/quantms_projects \
    --maracluster_pvalue_threshold -12.0 \
    --cluster_threshold 40 \
    -profile docker
```

### Example 4: Using Singularity on HPC

```bash
nextflow run main.nf \
    --parquet_dir /data/quantms_projects \
    --outdir /scratch/results \
    -profile singularity
```

### Example 5: Resume Failed Run

```bash
# If a run fails or is interrupted, resume it:
nextflow run main.nf \
    --parquet_dir /data/quantms_projects \
    -profile docker \
    -resume
```

## Consensus Spectrum Strategies

The workflow supports four different strategies for generating consensus spectra from clusters:

1. **`best`** (default): Selects the spectrum with the best quality metric (lowest posterior error probability or global q-value) as the consensus spectrum.

2. **`most`**: Selects the spectrum most similar to all other spectra in the cluster using similarity measures (e.g., dot product).

3. **`bin`**: Uses binning-based approach where peaks are binned by m/z, and peaks present in a quorum of spectra are included in the consensus.

4. **`average`**: Computes an averaged spectrum from all spectra in the cluster, with configurable peak alignment and filtering.

Choose the strategy based on your use case:
- **`best`**: Fast, good for high-quality data
- **`most`**: Good for finding representative spectra
- **`bin`**: Good for noisy data, robust peak detection
- **`average`**: Good for high-quality clusters, smooth spectra

## Troubleshooting

### Common Issues

1. **"Please provide a folder containing the files that will be clustered (--parquet_dir)"**
   - Solution: Ensure you provide the `--parquet_dir` parameter with a valid path.

2. **Container platform mismatch (ARM64 vs AMD64)**
   - Solution: Use `-profile docker,arm64` on Apple Silicon, or `-profile docker,emulate_amd64` to emulate AMD64.

3. **Memory errors during clustering**
   - Solution: Increase `--max_memory` or reduce the number of parallel processes.

4. **Missing SDRF files**
   - Solution: Ensure each project directory contains at least one `.sdrf.tsv` file.

5. **Missing spectra in parquet files**
   - Solution: Ensure parquet files contain `mz_array` and `intensity_array` columns.

### Getting Help

- Check the [Nextflow log](https://www.nextflow.io/docs/latest/tracing.html) for detailed error messages
- Review the execution report in `results/pipeline_info/execution_report.html`
- Open an issue on [GitHub](https://github.com/bigbio/spectrafuse/issues)

## Citation

If you use spectrafuse in your research, please cite:

- The spectrafuse workflow (when published)
- [MaRaCluster](https://github.com/statisticalbiotechnology/maracluster) for the clustering algorithm
- [quantms](https://quantms.org) for the reanalysis workflow

## License

This workflow is licensed under the MIT License. See the LICENSE file for details.

## Contributing

Contributions are welcome! Please see the [Contributing Guidelines](CONTRIBUTING.md) for more information.

## Acknowledgments

- [MaRaCluster](https://github.com/statisticalbiotechnology/maracluster) for the clustering algorithm
- [quantms](https://quantms.org) for the proteomics reanalysis workflow
- [Nextflow](https://www.nextflow.io/) for the workflow management system
- [nf-core](https://nf-co.re/) for workflow best practices and infrastructure
